---
layout: post
title: "Python에서 이진파일 (Binary file) 입출력"
comments: true
share: true
date: 2019-07-07 12:58:00
description: Python에서 이진 파일을 다루는 법을 소개한다.
tags: python
toc: true
sitemap :
  changefreq : daily
  priority : 1.0
---

# Python에서 이진파일 (Binary file) 입출력

Python에는 이진파일을 다루는 여러 방법이 존재한다. 여기서는 numpy, struct, ctypes를 이용하는 방법을 소개한다.

  
밑의 예제코드들에서 다룰 이진파일의 구조는 다음과 같다.
```cpp
// Litte endian
struct header
{
    int8_t val1 = -34;
    uint16_t val2 = 257;
    double_t val3 = 36.3948;
    float_t array[3][2] = 
    {
        {1.1, 8.8},
        {5.5, 9.9},
        {6.6, 7.7}
    };
    std::complex<double> carray[5] = 
    {
        {1, 2}, {3, 4}, {5, 6}, {7, 8}, {8, 9}
    };
};
```

<br>

## 1. Numpy module을 이용한 이진파일 처리

Numpy에서는 행렬 저장을 위한 Npy 파일 형태만이 아니라 C언어 형태의 이진파일을 읽고 쓸수 있다. Bitfield를 포함하는 이진파일이 아니라면 Numpy API로 이진 파일을 다룰수 있기 때문에 내가 가장 많이 쓰는 방법이다.  
  
이진파일을 처리하기 위해서는 우선 Byte order와 자료형명이 정해져야 한다. Byte order와 자료형명은 다음과 같다.

<br>

### 1.1. Byte order[1]

Numpy에서 Byte order는 <, >를 이용하여 지정할 수 있다. 자료형명과 붙여서 사용하게 된다.

| Character | Byte order             |
|-----------|------------------------|
| =         | native                 |
| <         | little-endian          |
| >         | big-endian             |
| \|        | not applicable         |

<br>

### 1.2. 자료형명

numpy.sctypeDict를 참조하면 다음과 같다.

| Code   | C Type                  | Alias                                                        | Size |
|--------|-------------------------|--------------------------------------------------------------|------|
| ?, b1  | _Bool                   | bool, Bool, bool8                                            | 1    |
| b, i1  | signed char             | int8, Int8, byte                                             | 1    |
| B, u1  | unsigned char           | uint8, UInt8, ubyte                                          | 1    |
| h, i2  | short                   | int16, Int16, short                                          | 2    |
| H, u2  | unsigned short          | uint16, UInt16, ushort                                       | 2    |
| i, i4  | int                     | int32, Int32, intc                                           | 4    |
| I, u4  | unsigned int            | uint32, UInt32, uintc                                        | 4    |
| l, i8  | long                    | int, int0, int64, Int64, intp, long                          | 8    |
| L, u8  | unsigned long           | uint, uint0, uint64, Uint64, UInt64, uintp                   | 8    |
| q      | long long               | longlong                                                     | 8    |
| Q      | unsigned long long      | ulonglong                                                    | 8    |
| e, f2  | half precision          | float16, Float16, half                                       | 2    |
| f, f4  | float                   | float32, Float32, single                                     | 4    |
| d, f8  | double                  | float, float64, Float64, double                              | 8    |
| g, f16 | \_\_float128            | float128, Float128, longdouble, longfloat                    | 16   |
| F, c8  | complex\<float\>        | Complex32, complex64, csingle, singlecomplex                 | 8    |
| D, c16 | complex\<double\>       | cdouble, cfloat, complex, complex128, Complex64              | 16   |
| G, c32 | complex\<\_\_float128\> | clongdouble, clongfloat, Complex128, complex256, longcomplex | 32   |

Numpy는 하나의 자료형에 너무 많은 이름을 지원하고 있다. signed char를 표현하는 방법은 'b', 'i1', 'int8', 'Int8', 'byte',
numpy.byte, numpy.int8 등 7가지로 오히려 혼란스럽다. 특히 Complex자료형의 경우 Complex32와 complex32 전혀 다른 자료형이므로 numpy 자료형에서는 대소문자에 특별히 유의하여야 한다.



<br>

### 1.3. 이진 파일 읽기
Numpy에서는 이진 파일 전체를 dict형태로 읽어오는 방법과 변수별로 읽어오는 방법이 있다.

<br>

#### 1.3.1. 파일을 dict에 저장
파일 전체를 dict에 저장하기 위해서는 읽어올 변수와 변수들의 자료형을 모두 선언해야 한다.


```python
import numpy as np

types = np.dtype([('val1', '<b'),
                  ('val2', '<u2'),
                  ('valf', 'float64'),
                  ('array1', '<(3, 2)f'),
                  ('array2', '5complex128')])

data = np.fromfile('data_c.dat', types)
print(data['val1'])
print(data['val2'])
print(data['valf'])
print(data['array1'])
print(data['array2'])
```

    [-34]
    [257]
    [36.3948]
    [[[1.1 8.8]
      [5.5 9.9]
      [6.6 7.7]]]
    [[1.+2.j 3.+4.j 5.+6.j 7.+8.j 8.+9.j]]


<br>

## 2. Struct module을 이용한 이진파일 처리

### 2.1. Byte order [2]

| Character | Byte order             | Size     | Alignment |
|-----------|------------------------|----------|-----------|
| @         | native                 | native   | native    |
| =         | native                 | standard | none      |
| <         | little-endian          | standard | none      |
| >         | big-endian             | standard | none      |
| !         | network (= big-endian) | standard | none      |

<br>

### 2.2. Format Characters [2]

| Format | C Type             | Python type       | Standard size |
|--------|--------------------|-------------------|---------------|
| x      | pad byte           | no value          |               |
| c      | char               | bytes of length 1 | 1             |
| b      | signed char        | integer           | 1             |
| B      | unsigned char      | integer           | 1             |
| ?      | _Bool              | bool              | 1             |
| h      | short              | integer           | 2             |
| H      | unsigned short     | integer           | 2             |
| i      | int                | integer           | 4             |
| I      | unsigned int       | integer           | 4             |
| l      | long               | integer           | 4             |
| L      | unsigned long      | integer           | 4             |
| q      | long long          | integer           | 8             |
| Q      | unsigned long long | integer           | 8             |
| n      | ssize_t            | integer           |               |
| N      | size_t             | integer           |               |
| e      | half precision     | float             | 2             |
| f      | float              | float             | 4             |
| d      | double             | float             | 8             |
| s      | char[]             | bytes             |               |
| p      | char[]             | bytes             |               |
| P      | void *             | integer           |               |

<br>

## 3. Ctype module을 이용한 이진파일 처리

## 4. 참고 문헌
[1] https://docs.scipy.org/doc/numpy/reference/generated/numpy.dtype.byteorder.html
[2] https://docs.python.org/3/library/struct.html